# 実運用コード修正リスト（緊急度順）

## 🚨 Priority 1: 即座に修正（取引前必須）

### 1. SL設定を10tickに変更
**ファイル**: `src/trade/config.py` line 43
```python
# 修正前
"y_tick": 5.0,  # 損切り（tick）

# 修正後
"y_tick": 10.0,  # 損切り（v1.0設定：10tick）
```

**理由**: v1.0のリスク計算は10tick損切り前提。5tickだと想定の2倍の損失頻度になる。

---

### 2. 指値価格を実価格に変更
**ファイル**: `src/trade/order_executor.py` line 263
```python
# 修正前
price = 500  # 指値価格を500に固定

# 修正後
price = signal["price"]  # 実際の市場価格を使用
```

**理由**: 500円固定は完全に間違い。約定しないか、大幅なスリッページが発生する。

---

### 3. v1.0環境フィルタの実装
**ファイル**: `src/trade/signal_generator.py`

**追加必要項目**:
```python
# check_entry_signal() に追加
# 1. micro_bias_open_10m_mean > -0.05 のチェック
# 2. daily_support_dist_atr ≤ 0.025 のチェック
# 3. entry_start_time ≥ 09:10:00 のチェック
```

**理由**: v1.0の核心フィルタが未実装。これがないと全く別の戦略になる。

---

## ⚠️ Priority 2: 理解必須（ロット計算変更）

### 4. 信用取引前提の明確化
**現状**: README.md で「信用取引（いちにち信用）」と明記

**影響**:
- 現物取引ではない = 建玉拘束資金不要
- レバレッジが効く = ロット計算式が変わる
- v1.0設定文書の「1単元=71,000円」は不適用

**必要なアクション**:
1. ユーザーに信用取引の理解を確認
2. 信用取引用のロット計算式を再作成
3. または現物取引に変更（コード修正大）

---

### 5. 手数料・スリッページの実測
**現状**: v1.0では「片道0.5tick + スリッページ0.5tick + 呼値1.0tick」想定

**信用取引の実際**:
- いちにち信用手数料: 無料（楽天証券）
- 金利: わずか（日計算）
- スリッページ: 実測必要

**必要なアクション**:
- Phase 0（超小ロット）で実測
- 実測値で v1.0_FINAL_SPEC.md のコスト前提を修正

---

## 📝 Priority 3: 安全性向上

### 6. 最大ポジション数の見直し
**ファイル**: `src/trade/config.py` line 58
```python
"max_positions": 3,  # 同時保有最大数
```

**v1.0設定との整合性**:
- 信用取引なら3ポジションは妥当
- ただし各ポジションのサイズ（100株）×3 = 300株同時保有
- v1.0想定（5-8単元）と整合性確認が必要

---

### 7. pending注文タイムアウトの確認
**ファイル**: `src/trade/config.py` line 95
```python
"pending_order_timeout_sec": 30,  # pending注文の最大待機時間（秒）
```

**確認事項**:
- 30秒で約定しない場合のキャンセル処理は？
- 部分約定の処理は？
- 約定確認の頻度（1秒）は適切か？

---

## 🔍 Priority 4: 検証推奨

### 8. LOB特徴量の整合性
**ファイル**: `src/trade/signal_generator.py` line 152-184

**確認事項**:
- バックテストで使用したLOB特徴量と同じ計算式か？
- micro_bias, ofi, qi, depth_imb の定義が一致しているか？
- ローリングウィンドウ（roll_n=20）が正しく動作しているか？

---

### 9. レベル生成ロジックの確認
**ファイル**: `src/trade/signal_generator.py` line 48

**確認事項**:
- `find_support_resistance_lines()` がバックテストと同じか？
- lookback_bars, bin_size, pivot_left/right が v1.0設定と一致しているか？
- レベル強度の計算式が同じか？

---

## 📊 修正後の確認手順

### Step 1: コード修正
1. Priority 1 の3項目を修正
2. git commit で履歴を残す

### Step 2: DRY_RUN テスト
```python
# config.py
DRY_RUN = True
```
1. main.py を実行
2. ログでシグナル生成を確認
3. フィルタが正しく機能しているか確認

### Step 3: Phase 0 実運用
- 最小ロット（1単元 or 100株）
- 1週間の実測
- スリッページ・約定率・実PnLを記録

---

## 🚫 絶対にやってはいけないこと

1. ❌ Priority 1 を修正せずに本番実行
2. ❌ 信用取引の理解なしに実行
3. ❌ DRY_RUNなしにいきなり本番
4. ❌ v1.0フィルタ未実装のまま実行
5. ❌ 実価格ではなく固定価格で発注

---

## 📝 次のアクション

1. この修正リストをユーザーに提示
2. 信用取引 vs 現物取引の選択を確認
3. Priority 1の3項目を即座に修正
4. DRY_RUN テストを実施
5. 結果を確認してから Phase 0 へ
